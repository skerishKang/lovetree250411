import{r as n,c as v,d as x,j as e,M as p,N as y,O as C,P as S,Q as b,S as k}from"./index-Bv4-c3_I.js";function E({title:a,titleId:o,...i},d){return n.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:d,"aria-labelledby":o},i),a?n.createElement("title",{id:o},a):null,n.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M2.25 12.76c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.076-4.076a1.526 1.526 0 0 1 1.037-.443 48.282 48.282 0 0 0 5.68-.494c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0 0 12 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018Z"}))}const M=n.forwardRef(E),I=()=>{const a=v(),{activeChat:o,onlineUsers:i}=x(l=>l.chat),[d,r]=n.useState([]),[t,c]=n.useState(!0);n.useEffect(()=>(console.log("채팅 목록 컴포넌트 마운트"),(async()=>{try{console.log("채팅 사용자 목록 가져오기 시도");const u=await p.get("/api/chat/users");console.log("채팅 사용자 목록 가져오기 성공:",u.data),r(u.data),c(!1)}catch(u){console.error("채팅 목록을 불러오는데 실패했습니다:",u),c(!1)}})(),()=>{console.log("채팅 목록 컴포넌트 언마운트")}),[]);const m=l=>{console.log("사용자 선택:",l),a(y(l))};return t?(console.log("채팅 목록 로딩 중"),e.jsx("div",{className:"w-80 bg-white h-full border-r",children:e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"})})})):(console.log("채팅 목록 렌더링:",{users:d,activeChat:o}),e.jsxs("div",{className:"w-80 bg-white h-full border-r",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsx("h2",{className:"text-xl font-semibold",children:"채팅"})}),e.jsx("div",{className:"overflow-y-auto",children:d.map(l=>e.jsxs("div",{className:`flex items-center p-4 cursor-pointer hover:bg-gray-50 ${o===l.id?"bg-blue-50":""}`,onClick:()=>m(l.id),children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:l.profileImage||"/default-profile.png",alt:l.username,className:"w-12 h-12 rounded-full"}),l.isOnline&&e.jsx("div",{className:"absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"})]}),e.jsxs("div",{className:"ml-3 flex-1",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("p",{className:"font-semibold",children:l.username}),l.lastMessageTime&&e.jsx("p",{className:"text-xs text-gray-500",children:new Date(l.lastMessageTime).toLocaleTimeString()})]}),l.lastMessage&&e.jsx("p",{className:"text-sm text-gray-500 truncate",children:l.lastMessage})]}),l.unreadCount&&l.unreadCount>0&&e.jsx("div",{className:"ml-2 bg-blue-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center",children:l.unreadCount})]},l.id))})]}))},L=()=>{var h,g;const a=v(),{users:o,messages:i,status:d}=x(s=>s.chat),{user:r}=x(s=>s.auth),[t,c]=n.useState(null),[m,l]=n.useState(""),[u,N]=n.useState(null),f=n.useRef(null);n.useEffect(()=>{console.log("채팅 컴포넌트 마운트"),a(C());const s=S("http://localhost:5000",{auth:{token:localStorage.getItem("token")}});return console.log("소켓 연결 시도"),N(s),()=>{console.log("채팅 컴포넌트 언마운트, 소켓 연결 종료"),s.close()}},[a]),n.useEffect(()=>{t&&(console.log("선택된 사용자 변경:",t),a(b(t)))},[a,t]),n.useEffect(()=>{u&&(console.log("소켓 이벤트 리스너 설정"),u.on("message",s=>{console.log("새 메시지 수신:",s),(s.sender===t||s.receiver===t)&&a(b(t))}))},[u,t,a]),n.useEffect(()=>{var s;console.log("메시지 목록 업데이트, 스크롤 이동"),(s=f.current)==null||s.scrollIntoView({behavior:"smooth"})},[i]);const w=async s=>{if(s.preventDefault(),!m.trim()||!t){console.log("메시지 전송 실패: 빈 메시지 또는 선택된 사용자 없음");return}console.log("메시지 전송 시도:",{receiver:t,content:m}),await a(k({receiver:t,content:m})),l("")};return e.jsxs("div",{className:"flex h-[calc(100vh-64px)]",children:[e.jsx("div",{className:"w-1/3 border-r",children:e.jsxs("div",{className:"p-4",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"채팅"}),o.map(s=>{var j;return e.jsxs("div",{className:`flex items-center p-3 cursor-pointer hover:bg-gray-100 ${t===s._id?"bg-gray-100":""}`,onClick:()=>c(s._id),children:[e.jsx("img",{src:s.profileImage||"/default-profile.png",alt:s.username,className:"w-10 h-10 rounded-full mr-3"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-semibold",children:s.username}),e.jsx("div",{className:"text-sm text-gray-500 truncate",children:(j=s.lastMessage)==null?void 0:j.content})]}),s.unreadCount>0&&e.jsx("div",{className:"ml-2 bg-blue-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs",children:s.unreadCount}),s.isOnline&&e.jsx("div",{className:"ml-2 w-2 h-2 bg-green-500 rounded-full"})]},s._id)})]})}),e.jsx("div",{className:"w-2/3 flex flex-col",children:t?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b flex items-center",children:[e.jsx("img",{src:((h=o.find(s=>s._id===t))==null?void 0:h.profileImage)||"/default-profile.png",alt:"",className:"w-8 h-8 rounded-full mr-3"}),e.jsx("h3",{className:"font-semibold",children:(g=o.find(s=>s._id===t))==null?void 0:g.username})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[i.map(s=>e.jsxs("div",{className:`mb-4 ${s.sender===(r==null?void 0:r._id)?"text-right":"text-left"}`,children:[e.jsx("div",{className:`inline-block p-3 rounded-lg ${s.sender===(r==null?void 0:r._id)?"bg-blue-500 text-white":"bg-gray-200"}`,children:s.content}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:new Date(s.createdAt).toLocaleTimeString()})]},s._id)),e.jsx("div",{ref:f})]}),e.jsx("form",{onSubmit:w,className:"p-4 border-t",children:e.jsxs("div",{className:"flex",children:[e.jsx("input",{type:"text",value:m,onChange:s=>l(s.target.value),placeholder:"메시지를 입력하세요...",className:"flex-1 border rounded-l-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("button",{type:"submit",className:"bg-blue-500 text-white px-4 py-2 rounded-r-lg hover:bg-blue-600",children:"전송"})]})})]}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx(M,{className:"w-12 h-12 mx-auto mb-2"}),e.jsx("p",{children:"채팅을 선택해주세요"})]})})})]})},R=()=>{const{activeChat:a}=x(t=>t.chat),[o,i]=n.useState(null),[d,r]=n.useState(!1);return n.useEffect(()=>(console.log("채팅 페이지 컴포넌트 마운트"),()=>{console.log("채팅 페이지 컴포넌트 언마운트")}),[]),n.useEffect(()=>{a?(console.log("활성 채팅 변경:",a),(async()=>{r(!0);try{console.log("사용자 정보 가져오기 시도:",a);const c=await p.get(`/api/users/${a}`);console.log("사용자 정보 가져오기 성공:",c.data),i(c.data)}catch(c){console.error("사용자 정보를 불러오는데 실패했습니다:",c)}finally{r(!1)}})()):(console.log("활성 채팅 없음"),i(null))},[a]),console.log("채팅 페이지 렌더링:",{activeChat:a,selectedUser:o,loading:d}),e.jsxs("div",{className:"flex h-[calc(100vh-4rem)]",children:[e.jsx(I,{}),e.jsx("div",{className:"flex-1 bg-gray-50",children:d?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"})}):o?e.jsx(L,{userId:o.id,username:o.username,profileImage:o.profileImage}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("p",{className:"text-gray-500",children:"채팅할 사용자를 선택해주세요."})})})]})};export{R as default};
//# sourceMappingURL=ChatPage-Dr8WZdY1.js.map
